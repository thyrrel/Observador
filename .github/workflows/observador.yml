# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ğŸš€ Workflow Unificado - Observador CI/CD    â”ƒ
# â”ƒ ğŸ—ï¸ Um workflow para governar todos!         â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

name: "ğŸš€ Observador"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do app (ex: 1.2.3)'
        required: false
        default: '1.0.0'
        type: string
      skip_desktop:
        description: 'Pular builds de Desktop? (true/false)'
        required: false
        default: 'true'
        type: string
      skip_ios:
        description: 'Pular build do iOS? (true/false)'
        required: false
        default: 'true'
        type: string

permissions:
  contents: read
  actions: read
  checks: write

env:
  FLUTTER_VERSION: '3.22.0'
  JAVA_VERSION: '17'

jobs:
  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ğŸ”§ Setup, ValidaÃ§Ã£o e Testes                 â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  setup_and_test:
    name: "ğŸ”§ Setup & Test"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}

    steps:
      - name: "ğŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ğŸ’¾ Cache de dependÃªncias Pub"
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: "ğŸ” Verificar versÃ£o Flutter"
        run: |
          flutter --version
          flutter doctor -v

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ğŸ” AnÃ¡lise de cÃ³digo"
        run: flutter analyze --fatal-infos
        continue-on-error: true

      - name: "ğŸ§ª Executar testes unitÃ¡rios"
        run: flutter test
        continue-on-error: true

      - name: "ğŸ“Š Gerar informaÃ§Ãµes da versÃ£o"
        id: version
        run: |
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          BUILD_NUMBER=$((1000 + $GITHUB_RUN_NUMBER))
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“± VersÃ£o: $VERSION"
          echo "ğŸ”¢ Build: $BUILD_NUMBER"

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ğŸ“¦ Android Builds (APK & AAB)                â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  android_build:
    name: "ğŸ“¦ Android Build (APK & AAB)"
    needs: setup_and_test
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: "ğŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "â˜• Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "ğŸ’¾ Cache Gradle"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "ğŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ğŸ—ï¸ Build APK Release"
        run: |
          flutter build apk --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup_and_test.outputs.version }}" \
            --build-number="${{ needs.setup_and_test.outputs.build-number }}" \
            --target-platform android-arm,android-arm64,android-x64

      - name: "ğŸ“ Organizar APK Release"
        run: |
          cd build/app/outputs/flutter-apk/
          if [ -f "app-release.apk" ]; then
            mv app-release.apk "observador-v${{ needs.setup_and_test.outputs.version }}-${{ needs.setup_and_test.outputs.build-number }}.apk"
            ls -la
          else
            echo "âŒ Erro: app-release.apk nÃ£o encontrado!"
            exit 1
          fi

      - name: "ğŸ“¤ Upload APK Release"
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: "ğŸ“±-observador-release-apk"
          path: build/app/outputs/flutter-apk/observador-v*.apk
          retention-days: 90
          if-no-files-found: error

      - name: "ğŸ—ï¸ Build AAB Release"
        run: |
          flutter build appbundle --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup_and_test.outputs.version }}" \
            --build-number="${{ needs.setup_and_test.outputs.build-number }}"

      - name: "ğŸ“ Organizar AAB Release"
        run: |
          cd build/app/outputs/bundle/release/
          if [ -f "app-release.aab" ]; then
            mv app-release.aab "observador-v${{ needs.setup_and_test.outputs.version }}-${{ needs.setup_and_test.outputs.build-number }}.aab"
            ls -la
          else
            echo "âŒ Erro: app-release.aab nÃ£o encontrado!"
            exit 1
          fi

      - name: "ğŸ“¤ Upload AAB Release"
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: "ğŸ“¦-observador-release-aab"
          path: build/app/outputs/bundle/release/observador-v*.aab
          retention-days: 90
          if-no-files-found: error

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ğŸ–¥ï¸ Desktop Builds (Linux, Windows, macOS)     â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  desktop_build:
    name: "ğŸ–¥ï¸ Desktop Builds"
    needs: setup_and_test
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.skip_desktop != 'true'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: "ğŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ğŸ“¦ Instalar dependÃªncias Linux (se aplicÃ¡vel)"
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: "ğŸ“¦ Instalar dependÃªncias Flutter"
        run: flutter pub get

      - name: "ğŸ—ï¸ Build Linux"
        if: runner.os == 'Linux'
        run: flutter build linux --release

      - name: "ğŸ—ï¸ Build Windows"
        if: runner.os == 'Windows'
        run: flutter build windows --release

      - name: "ğŸ—ï¸ Build macOS"
        if: runner.os == 'macOS'
        run: flutter build macos --release

      - name: "ğŸ“¦ Verificar build Linux"
        if: runner.os == 'Linux'
        run: |
          if [ -d "build/linux/x64/release/bundle/" ]; then
            echo "âœ… Build Linux encontrado"
            ls -la build/linux/x64/release/bundle/
          else
            echo "âŒ Erro: Build Linux nÃ£o encontrado!"
            exit 1
          fi

      - name: "ğŸ“¤ Upload Build Linux"
        if: runner.os == 'Linux' && success()
        uses: actions/upload-artifact@v4
        with:
          name: "observador-Linux"
          path: build/linux/x64/release/bundle/
          retention-days: 30
          if-no-files-found: error

      - name: "ğŸ“¦ Verificar build Windows"
        if: runner.os == 'Windows'
        run: |
          if (Test-Path "build/windows/runner/Release/") {
            Write-Host "âœ… Build Windows encontrado"
            Get-ChildItem "build/windows/runner/Release/"
          } else {
            Write-Host "âŒ Erro: Build Windows nÃ£o encontrado!"
            exit 1
          }
        shell: pwsh

      - name: "ğŸ“¤ Upload Build Windows"
        if: runner.os == 'Windows' && success()
        uses: actions/upload-artifact@v4
        with:
          name: "observador-Windows"
          path: build/windows/runner/Release/
          retention-days: 30
          if-no-files-found: error

      - name: "ğŸ“¦ Verificar build macOS"
        if: runner.os == 'macOS'
        run: |
          if [ -d "build/macos/Build/Products/Release/" ]; then
            echo "âœ… Build macOS encontrado"
            ls -la build/macos/Build/Products/Release/
          else
            echo "âŒ Erro: Build macOS nÃ£o encontrado!"
            exit 1
          fi

      - name: "ğŸ“¤ Upload Build macOS"
        if: runner.os == 'macOS' && success()
        uses: actions/upload-artifact@v4
        with:
          name: "observador-macOS"
          path: build/macos/Build/Products/Release/
          retention-days: 30
          if-no-files-found: error

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ğŸ iOS Build                                 â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  ios_build:
    name: "ğŸ iOS Build"
    needs: setup_and_test
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.skip_ios != 'true'
    timeout-minutes: 60
    runs-on: macos-latest

    steps:
      - name: "ğŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ğŸ—ï¸ Build iOS (sem assinatura)"
        run: flutter build ios --release --no-codesign

      - name: "ğŸ“¦ Verificar build iOS"
        run: |
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âœ… Build iOS encontrado"
            ls -la build/ios/iphoneos/
          else
            echo "âŒ Erro: Build iOS nÃ£o encontrado!"
            exit 1
          fi

      - name: "ğŸ“¤ Upload IPA"
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: "observador-ios-build"
          path: build/ios/iphoneos/Runner.app
          retention-days: 30
          if-no-files-found: error

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ğŸ“Š Resumo Final                              â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  summary:
    name: "ğŸ“Š Resumo do Build"
    needs: [setup_and_test, android_build]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "ğŸ“Š Resumo Final"
        run: |
          echo "ğŸ‰ Build do Observador concluÃ­do!"
          echo ""
          echo "ğŸ“± VersÃ£o: ${{ needs.setup_and_test.outputs.version }}"
          echo "ğŸ”¢ Build: ${{ needs.setup_and_test.outputs.build-number }}"
          echo "ğŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… Status dos builds:"
          echo "   ğŸ”§ Setup & Test: ${{ needs.setup_and_test.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}"
          echo "   ğŸ“¦ Android Build: ${{ needs.android_build.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}"
          echo ""
          echo "ğŸ“¥ Para baixar os arquivos, vÃ¡ para a aba 'Actions' e encontre os artifacts desta execuÃ§Ã£o."
