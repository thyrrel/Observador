name: Observador

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.1" # atualizado para Dart >=3.4.0
          channel: stable

      - name: Limpar build anterior
        run: flutter clean

      - name: Instalar dependências
        run: flutter pub get

      - name: Atualizar plugins (force upgrade)
        run: |
          flutter pub outdated
          flutter pub upgrade

      - name: Obter versão do build
        id: version
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            BUILD_TYPE="pr"
            SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
            BUILD_VERSION="pr-${SHORT_SHA}"
          else
            if [[ "${GITHUB_REF##*/}" == v* ]]; then
              BUILD_VERSION="${GITHUB_REF##*/}"
              if [[ "$BUILD_VERSION" =~ - ]]; then
                BUILD_TYPE="beta"
              else
                BUILD_TYPE="release"
              fi
            else
              BUILD_TYPE="pr"
              SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
              BUILD_VERSION="pr-${SHORT_SHA}"
            fi
          fi
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV

          CLEAN_VERSION=$(echo $BUILD_VERSION | sed 's/^v//' | sed 's/[^0-9\.]//g')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN_VERSION"
          BASE_VERSION_CODE=$(printf "%d%02d%02d" ${MAJOR:-0} ${MINOR:-0} ${PATCH:-0})
          if [[ "$BUILD_TYPE" == "beta" ]]; then
            VERSION_CODE=$((BASE_VERSION_CODE + 1000000))
          elif [[ "$BUILD_TYPE" == "pr" ]]; then
            VERSION_CODE=$((BASE_VERSION_CODE + 2000000))
          else
            VERSION_CODE=$BASE_VERSION_CODE
          fi
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "Versão do build: $BUILD_VERSION, versionCode: $VERSION_CODE, tipo: $BUILD_TYPE"

      - name: Atualizar versionCode no build.gradle
        run: |
          sed -i "s/versionCode [0-9]\+/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$BUILD_VERSION\"/" android/app/build.gradle
          echo "Versão atualizada no build.gradle:"
          grep "version" android/app/build.gradle

      - name: Build APK (release)
        run: flutter build apk --release --build-name=$BUILD_VERSION --build-number=$VERSION_CODE

      - name: Build AAB (release)
        run: flutter build appbundle --release --build-name=$BUILD_VERSION --build-number=$VERSION_CODE

      - name: Upload de APK e AAB (sem compressão)
        uses: actions/upload-artifact@v4
        with:
          name: observador-$BUILD_TYPE-$BUILD_VERSION
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          compression-level: 0
          if-no-files-found: error
