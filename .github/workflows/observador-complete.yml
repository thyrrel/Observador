# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ðŸš€ Workflow Principal - Observador          â”ƒ
# â”ƒ ðŸ“± APK e AAB sempre funcionais              â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

name: "ðŸš€ Observador"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do app (ex: 1.2.3)'
        required: false
        default: '1.0.0'
        type: string

env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'

jobs:
  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ðŸ”§ Setup e ValidaÃ§Ã£o                        â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  setup:
    name: "ðŸ”§ Setup e ValidaÃ§Ã£o"
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
      
    steps:
      - name: "ðŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "ðŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ðŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ðŸ” AnÃ¡lise de cÃ³digo"
        run: flutter analyze --fatal-infos

      - name: "ðŸ§ª Executar testes unitÃ¡rios"
        run: flutter test

      - name: "ðŸ“Š Gerar informaÃ§Ãµes da versÃ£o"
        id: version
        run: |
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          BUILD_NUMBER=$((1000 + $GITHUB_RUN_NUMBER))
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“± VersÃ£o: $VERSION"
          echo "ðŸ”¢ Build: $BUILD_NUMBER"

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ðŸ§ª Android Test Build                       â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  android-test:
    name: "ðŸ§ª Android Test"
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "â˜• Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "ðŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ðŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ðŸ—ï¸ Build APK Test"
        run: |
          flutter build apk --debug \
            --dart-define=FLAVOR=test \
            --dart-define=APP_NAME="Observador Test" \
            --build-name="${{ needs.setup.outputs.version }}-test" \
            --build-number="${{ needs.setup.outputs.build-number }}"

      - name: "ðŸ“ Organizar APK Test"
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-debug.apk "observador-test-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk"
          ls -la

      - name: "ðŸ“¤ Upload APK Test"
        uses: actions/upload-artifact@v4
        with:
          name: "ðŸ§ª-observador-test-apk"
          path: build/app/outputs/flutter-apk/observador-test-*.apk
          retention-days: 30

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ðŸ“± Android APK Release - SEMPRE EXECUTA      â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  android-apk:
    name: "ðŸ“± Android APK Release"
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "â˜• Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "ðŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ðŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ðŸ—ï¸ Build APK Release"
        run: |
          echo "ðŸ—ï¸ Iniciando build APK Release..."
          flutter build apk --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup.outputs.version }}" \
            --build-number="${{ needs.setup.outputs.build-number }}" \
            --target-platform android-arm,android-arm64,android-x64

      - name: "ðŸ“ Organizar APK Release"
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-release.apk "observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk"
          
          # Criar informaÃ§Ãµes do build
          cat > build-info.txt << EOF
          ðŸ“± Observador APK - v${{ needs.setup.outputs.version }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ”¢ VersÃ£o: ${{ needs.setup.outputs.version }}
          ðŸ—ï¸ Build: ${{ needs.setup.outputs.build-number }}
          ðŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ðŸŒ¿ Branch: ${{ github.ref_name }}
          ðŸ“ Commit: ${{ github.sha }}
          ðŸ’¾ Tamanho: $(du -h observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk | cut -f1)
          
          ðŸš€ InstalaÃ§Ã£o:
          1. Baixe o APK
          2. Ative "Fontes desconhecidas" no Android
          3. Instale normalmente
          EOF
          
          echo "âœ… APK organizado:"
          ls -la

      - name: "ðŸ“¤ Upload APK Release"
        uses: actions/upload-artifact@v4
        with:
          name: "ðŸ“±-observador-release-apk"
          path: |
            build/app/outputs/flutter-apk/observador-v*.apk
            build/app/outputs/flutter-apk/build-info.txt
          retention-days: 90

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ðŸ“¦ Android AAB Release - SEMPRE EXECUTA      â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  android-aab:
    name: "ðŸ“¦ Android AAB Release"
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout cÃ³digo"
        uses: actions/checkout@v4

      - name: "â˜• Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "ðŸ› ï¸ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "ðŸ“¦ Instalar dependÃªncias"
        run: flutter pub get

      - name: "ðŸ—ï¸ Build AAB Release"
        run: |
          echo "ðŸ—ï¸ Iniciando build AAB Release..."
          flutter build appbundle --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup.outputs.version }}" \
            --build-number="${{ needs.setup.outputs.build-number }}"

      - name: "ðŸ“ Organizar AAB Release"
        run: |
          cd build/app/outputs/bundle/release/
          mv app-release.aab "observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.aab"
          
          # Criar informaÃ§Ãµes do build AAB
          cat > build-info-aab.txt << EOF
          ðŸ“¦ Observador AAB - v${{ needs.setup.outputs.version }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ”¢ VersÃ£o: ${{ needs.setup.outputs.version }}
          ðŸ—ï¸ Build: ${{ needs.setup.outputs.build-number }}
          ðŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S UTC')
          ðŸŒ¿ Branch: ${{ github.ref_name }}
          ðŸ“ Commit: ${{ github.sha }}
          ðŸ’¾ Tamanho: $(du -h observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.aab | cut -f1)
          
          ðŸª Google Play Store:
          1. FaÃ§a upload no Play Console
          2. Configure detalhes da versÃ£o
          3. Publique para testers ou produÃ§Ã£o
          
          ðŸ“± InstalaÃ§Ã£o manual:
          1. Use bundletool para extrair APKs do AAB
          2. Instale via ADB
          EOF
          
          echo "âœ… AAB organizado:"
          ls -la

      - name: "ðŸ“¤ Upload AAB Release"
        uses: actions/upload-artifact@v4
        with:
          name: "ðŸ“¦-observador-release-aab"
          path: |
            build/app/outputs/bundle/release/observador-v*.aab
            build/app/outputs/bundle/release/build-info-aab.txt
          retention-days: 90

  # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
  # â”‚ ðŸ“Š Resumo Final                              â”‚
  # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  summary:
    name: "ðŸ“Š Resumo do Build"
    needs: [setup, android-test, android-apk, android-aab]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“Š Resumo Final"
        run: |
          echo "ðŸŽ‰ Build do Observador concluÃ­do!"
          echo ""
          echo "ðŸ“± VersÃ£o: ${{ needs.setup.outputs.version }}"
          echo "ðŸ”¢ Build: ${{ needs.setup.outputs.build-number }}"
          echo "ðŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… Status dos builds:"
          echo "   ðŸ§ª Test APK: ${{ needs.android-test.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}"
          echo "   ðŸ“± Release APK: ${{ needs.android-apk.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}"
          echo "   ðŸ“¦ Release AAB: ${{ needs.android-aab.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }}"
          echo ""
          echo "ðŸ“¥ Para baixar os arquivos:"
          echo "   1. VÃ¡ para Actions > Esta execuÃ§Ã£o"
          echo "   2. Baixe os artifacts:"
          echo "      â€¢ ðŸ§ª-observador-test-apk (para testes)"
          echo "      â€¢ ðŸ“±-observador-release-apk (para instalaÃ§Ã£o)"
          echo "      â€¢ ðŸ“¦-observador-release-aab (para Play Store)"
          echo "   3. Extraia e instale diretamente no Android"
          echo ""
          echo "ðŸš€ APK e AAB prontos para uso!"
