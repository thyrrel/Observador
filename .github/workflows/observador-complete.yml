# ‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
# ‚îÉ üöÄ Workflow Principal - Observador          ‚îÉ
# ‚îÉ üì± Orquestra√ß√£o completa de builds          ‚îÉ
# ‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ

name: "üöÄ Observador - Build Completo"

on:
  push:
    branches: [main]
    paths: ['lib/**', 'pubspec.yaml', 'android/**', 'ios/**']
  pull_request:
    branches: [main]
  schedule:
    # Executa diariamente √†s 6h UTC - ajuste conforme renova√ß√£o dos cr√©ditos
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Vers√£o do app (ex: 1.2.3)'
        required: false
        default: '1.0.0'
        type: string
      build_android_test:
        description: 'üß™ Build Android Test'
        required: false
        default: true
        type: boolean
      build_android_apk:
        description: 'üì± Build Android APK'
        required: false
        default: true
        type: boolean
      build_android_aab:
        description: 'üì¶ Build Android AAB'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'üçé Build iOS'
        required: false
        default: false
        type: boolean
      build_desktop:
        description: 'üñ•Ô∏è Build Desktop'
        required: false
        default: false
        type: boolean

env:
  FLUTTER_VERSION: '3.24.5'
  JAVA_VERSION: '17'

jobs:
  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üîß Setup e Valida√ß√£o                        ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  setup:
    name: "üîß Setup e Valida√ß√£o"
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build-number: ${{ steps.version.outputs.build-number }}
      should-build: ${{ steps.changes.outputs.should-build }}
      
    steps:
      - name: "üì• Checkout c√≥digo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üõ†Ô∏è Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "üì¶ Instalar depend√™ncias"
        run: flutter pub get

      - name: "üîç An√°lise de c√≥digo"
        run: flutter analyze --fatal-infos

      - name: "üß™ Executar testes unit√°rios"
        run: flutter test

      - name: "üìä Gerar informa√ß√µes da vers√£o"
        id: version
        run: |
          VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          BUILD_NUMBER=$((1000 + $GITHUB_RUN_NUMBER))
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "üì± Vers√£o: $VERSION"
          echo "üî¢ Build: $BUILD_NUMBER"

      - name: "üîÑ Verificar mudan√ßas"
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          else
            # Verificar se houve mudan√ßas relevantes
            if git diff --name-only HEAD~1 | grep -E "(lib/|pubspec\.yaml|android/|ios/)" > /dev/null; then
              echo "should-build=true" >> $GITHUB_OUTPUT
            else
              echo "should-build=false" >> $GITHUB_OUTPUT
            fi
          fi

  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üß™ Android Test Build                       ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  android-test:
    name: "üß™ Android Test"
    needs: setup
    if: ${{ needs.setup.outputs.should-build == 'true' && (github.event.inputs.build_android_test != 'false') }}
    runs-on: ubuntu-latest
    
    steps:
      - name: "üì• Checkout c√≥digo"
        uses: actions/checkout@v4

      - name: "‚òï Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "üõ†Ô∏è Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "üì¶ Instalar depend√™ncias"
        run: flutter pub get

      - name: "üèóÔ∏è Build APK Test"
        run: |
          flutter build apk --debug \
            --dart-define=FLAVOR=test \
            --dart-define=APP_NAME="Observador Test" \
            --build-name="${{ needs.setup.outputs.version }}-test" \
            --build-number="${{ needs.setup.outputs.build-number }}"

      - name: "üìÅ Organizar APK Test"
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-debug.apk "observador-test-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk"

      - name: "üì§ Upload APK Test"
        uses: actions/upload-artifact@v4
        with:
          name: "üß™-observador-test-apk"
          path: build/app/outputs/flutter-apk/observador-test-*.apk
          retention-days: 30

  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üì± Android APK Release                       ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  android-apk:
    name: "üì± Android APK"
    needs: setup
    if: ${{ needs.setup.outputs.should-build == 'true' && (github.event.inputs.build_android_apk != 'false') }}
    runs-on: ubuntu-latest
    
    steps:
      - name: "üì• Checkout c√≥digo"
        uses: actions/checkout@v4

      - name: "‚òï Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "üõ†Ô∏è Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "üì¶ Instalar depend√™ncias"
        run: flutter pub get

      - name: "üèóÔ∏è Build APK Release"
        run: |
          flutter build apk --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup.outputs.version }}" \
            --build-number="${{ needs.setup.outputs.build-number }}" \
            --target-platform android-arm,android-arm64,android-x64

      - name: "üìÅ Organizar APK Release"
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-release.apk "observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk"
          
          # Criar informa√ß√µes do build
          cat > build-info.txt << EOF
          üì± Observador APK - v${{ needs.setup.outputs.version }}
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          üî¢ Vers√£o: ${{ needs.setup.outputs.version }}
          üèóÔ∏è Build: ${{ needs.setup.outputs.build-number }}
          üìÖ Data: $(date '+%Y-%m-%d %H:%M:%S UTC')
          üåø Branch: ${{ github.ref_name }}
          üìù Commit: ${{ github.sha }}
          üíæ Tamanho: $(du -h observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.apk | cut -f1)
          
          üöÄ Instala√ß√£o:
          1. Baixe o APK
          2. Ative "Fontes desconhecidas"
          3. Instale normalmente
          EOF

      - name: "üì§ Upload APK Release"
        uses: actions/upload-artifact@v4
        with:
          name: "üì±-observador-release-apk"
          path: |
            build/app/outputs/flutter-apk/observador-v*.apk
            build/app/outputs/flutter-apk/build-info.txt
          retention-days: 90

  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üì¶ Android AAB Release                       ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  android-aab:
    name: "üì¶ Android AAB"
    needs: setup
    if: ${{ needs.setup.outputs.should-build == 'true' && (github.event.inputs.build_android_aab != 'false') }}
    runs-on: ubuntu-latest
    
    steps:
      - name: "üì• Checkout c√≥digo"
        uses: actions/checkout@v4

      - name: "‚òï Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: "üõ†Ô∏è Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "üì¶ Instalar depend√™ncias"
        run: flutter pub get

      - name: "üèóÔ∏è Build AAB Release"
        run: |
          flutter build appbundle --release \
            --dart-define=FLAVOR=production \
            --dart-define=APP_NAME="Observador" \
            --build-name="${{ needs.setup.outputs.version }}" \
            --build-number="${{ needs.setup.outputs.build-number }}"

      - name: "üìÅ Organizar AAB Release"
        run: |
          cd build/app/outputs/bundle/release/
          mv app-release.aab "observador-v${{ needs.setup.outputs.version }}-${{ needs.setup.outputs.build-number }}.aab"

      - name: "üì§ Upload AAB Release"
        uses: actions/upload-artifact@v4
        with:
          name: "üì¶-observador-release-aab"
          path: build/app/outputs/bundle/release/observador-v*.aab
          retention-days: 90

  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üçé iOS Build (opcional)                      ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  ios:
    name: "üçé iOS Build"
    needs: setup
    if: ${{ needs.setup.outputs.should-build == 'true' && github.event.inputs.build_ios == 'true' }}
    runs-on: macos-latest
    
    steps:
      - name: "üì• Checkout c√≥digo"
        uses: actions/checkout@v4

      - name: "üõ†Ô∏è Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: "üì¶ Instalar depend√™ncias"
        run: flutter pub get

      - name: "üèóÔ∏è Build iOS"
        run: flutter build ios --release --no-codesign

      - name: "üì§ Upload iOS Build"
        uses: actions/upload-artifact@v4
        with:
          name: "üçé-observador-ios"
          path: build/ios/iphoneos/Runner.app
          retention-days: 30

  # ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
  # ‚îÇ üìä Resumo Final                              ‚îÇ
  # ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
  summary:
    name: "üìä Resumo do Build"
    needs: [setup, android-test, android-apk, android-aab]
    if: always() && needs.setup.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: "üìä Resumo Final"
        run: |
          echo "üéâ Build do Observador conclu√≠do!"
          echo ""
          echo "üì± Vers√£o: ${{ needs.setup.outputs.version }}"
          echo "üî¢ Build: ${{ needs.setup.outputs.build-number }}"
          echo "üìÖ Data: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "‚úÖ Builds realizados:"
          echo "   üß™ Test APK: ${{ needs.android-test.result == 'success' && '‚úÖ' || '‚ùå' }}"
          echo "   üì± Release APK: ${{ needs.android-apk.result == 'success' && '‚úÖ' || '‚ùå' }}"
          echo "   üì¶ Release AAB: ${{ needs.android-aab.result == 'success' && '‚úÖ' || '‚ùå' }}"
          echo "   üçé iOS: ${{ needs.ios.result == 'success' && '‚úÖ' || (github.event.inputs.build_ios == 'true' && '‚ùå' || '‚è≠Ô∏è') }}"
          echo ""
          echo "üîó Para baixar os arquivos:"
          echo "   1. V√° para Actions > Esta execu√ß√£o"
          echo "   2. Baixe os artifacts desejados"
          echo "   3. Extraia e instale"