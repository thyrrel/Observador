# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🧪 Workflow - Android Test                  ┃
# ┃ 📱 APK de teste com dados simulados         ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

name: "🧪 Android Test Build"

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['lib/**', 'pubspec.yaml', 'android/**']

jobs:
  android-test:
    name: "🧪 Build APK Teste"
    runs-on: ubuntu-latest
    
    steps:
      # ╭──────────────────────────────────────────────╮
      # │ 📥 Checkout do repositório                   │
      # ╰──────────────────────────────────────────────╯
      - name: "📥 Checkout código"
        uses: actions/checkout@v4

      # ╭──────────────────────────────────────────────╮
      # │ ☕ Configurar Java                           │
      # ╰──────────────────────────────────────────────╯
      - name: "☕ Configurar Java"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # ╭──────────────────────────────────────────────╮
      # │ 🛠️ Configurar Flutter                        │
      # ╰──────────────────────────────────────────────╯
      - name: "🛠️ Instalar Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          cache: true

      # ╭──────────────────────────────────────────────╮
      # │ 📦 Instalar dependências                     │
      # ╰──────────────────────────────────────────────╯
      - name: "📦 Instalar dependências"
        run: flutter pub get

      # ╭──────────────────────────────────────────────╮
      # │ 🧪 Executar testes                           │
      # ╰──────────────────────────────────────────────╯
      - name: "🧪 Executar testes"
        run: flutter test

      # ╭──────────────────────────────────────────────╮
      # │ 📊 Configurar dados de teste                 │
      # ╰──────────────────────────────────────────────╯
      - name: "📊 Configurar modo teste"
        run: |
          echo "🧪 Configurando dados simulados..."
          # Adicionar aqui configurações específicas para teste
          # Por exemplo: substituir arquivos de configuração
          
      # ╭──────────────────────────────────────────────╮
      # │ 🏗️ Build APK de teste                       │
      # ╰──────────────────────────────────────────────╯
      - name: "🏗️ Build APK Teste"
        run: |
          flutter build apk --debug \
            --dart-define=FLAVOR=test \
            --dart-define=APP_NAME="Observador Test" \
            --build-name="1.0.0-test" \
            --build-number=$((1000 + $GITHUB_RUN_NUMBER))

      # ╭──────────────────────────────────────────────╮
      # │ 📁 Renomear APK                              │
      # ╰──────────────────────────────────────────────╯
      - name: "📁 Renomear APK"
        run: |
          cd build/app/outputs/flutter-apk/
          mv app-debug.apk observador-test-v1.0.0-${{ github.run_number }}.apk
          ls -la

      # ╭──────────────────────────────────────────────╮
      # │ 📤 Upload APK Teste                          │
      # ╰──────────────────────────────────────────────╯
      - name: "📤 Upload APK Teste"
        uses: actions/upload-artifact@v4
        with:
          name: "observador-test-apk"
          path: build/app/outputs/flutter-apk/observador-test-*.apk
          retention-days: 30

      # ╭──────────────────────────────────────────────╮
      # │ 📱 Informações do build                      │
      # ╰──────────────────────────────────────────────╯
      - name: "📱 Informações do build"
        run: |
          echo "✅ APK de teste gerado com sucesso!"
          echo "📱 Arquivo: observador-test-v1.0.0-${{ github.run_number }}.apk"
          echo "📦 Tamanho: $(du -h build/app/outputs/flutter-apk/observador-test-*.apk | cut -f1)"
          echo "🔗 Baixe diretamente da aba Actions > Artifacts"
